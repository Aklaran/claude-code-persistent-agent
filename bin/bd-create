#!/bin/bash
# bd-create: Wrapper for bd create that enforces better bead quality

set -euo pipefail

BD_PATH=$(command -v bd 2>/dev/null || echo "${HOME}/.local/bin/bd")
if [ ! -x "$BD_PATH" ]; then
  echo "Error: bd not found. Install: go install github.com/codegangsta/beads/cmd/bd@latest"
  exit 1
fi

# Description template
TEMPLATE='
Good bead descriptions answer:
- WHY does this need to be done?
- WHAT specifically needs to change?
- WHERE in the codebase? (files/modules affected)
- HOW complex? (single file? multi-file? third-party API?)
'

show_help() {
    echo "bd-create: Wrapper for bd create with required descriptions"
    echo ""
    echo "Usage: bd-create --title TITLE --description DESCRIPTION [options]"
    echo ""
    echo "Required flags:"
    echo "  --description, -d    Description of the bead (REQUIRED)"
    echo ""
    echo "Common options:"
    echo "  --title, -t          Title of the bead"
    echo "  --type               Bead type (task, bug, feature, etc.)"
    echo "  --priority, -p       Priority level"
    echo ""
    echo "$TEMPLATE"
    echo ""
    echo "Example:"
    echo "  bd-create --title \"Fix login bug\" \\"
    echo "    --description \"Users can't log in because the API endpoint changed. \\"
    echo "                   Need to update auth.js to use /v2/auth instead of /v1/auth. \\"
    echo "                   Single file change.\" \\"
    echo "    --type bug --priority 1"
    exit 0
}

# Check for --help
for arg in "$@"; do
    if [[ "$arg" == "--help" ]] || [[ "$arg" == "-h" ]]; then
        show_help
    fi
done

# Parse arguments to check for description
has_description=false
description_text=""
title_text=""
all_text=""

i=0
args=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --description|-d)
            has_description=true
            if [[ $# -gt 1 ]] && [[ ! "$2" =~ ^- ]]; then
                description_text="$2"
                all_text="$all_text $2"
                args+=("$1" "$2")
                shift 2
            else
                echo "Error: --description requires a value" >&2
                exit 1
            fi
            ;;
        --title)
            if [[ $# -gt 1 ]] && [[ ! "$2" =~ ^- ]]; then
                title_text="$2"
                all_text="$all_text $2"
                # Pass as positional arg (first in args) since bd create takes title positionally
                args=("$2" "${args[@]}")
                shift 2
            else
                echo "Error: --title requires a value" >&2
                exit 1
            fi
            ;;
        *)
            args+=("$1")
            shift
            ;;
    esac
done

# Require description
if [[ "$has_description" == false ]]; then
    echo "Error: --description (or -d) is required" >&2
    echo "" >&2
    echo "$TEMPLATE" >&2
    echo "" >&2
    echo "Example:" >&2
    echo "  bd-create --title \"Fix login bug\" \\" >&2
    echo "    --description \"Users can't log in because the API endpoint changed. \\" >&2
    echo "                   Need to update auth.js to use /v2/auth instead of /v1/auth. \\" >&2
    echo "                   Single file change.\" \\" >&2
    echo "    --type bug --priority 1" >&2
    exit 1
fi

# Call bd create with all arguments
"$BD_PATH" create "${args[@]}"

# Suggest complexity tags based on keywords
echo ""
echo "ðŸ“‹ Tag suggestions based on content:"

suggested=false

# Convert to lowercase for case-insensitive matching
all_text_lower=$(echo "$all_text" | tr '[:upper:]' '[:lower:]')

# Check for various keywords
if [[ "$all_text_lower" =~ (api|upstream|third-party|dependency|external|vendor) ]]; then
    echo "  â€¢ Consider tag: external-dep (mentions external dependencies/APIs)"
    suggested=true
fi

if [[ "$all_text_lower" =~ (multi-file|refactor|cross-cutting|multiple files|across|codebase-wide) ]]; then
    echo "  â€¢ Consider tag: multi-file (affects multiple files)"
    suggested=true
fi

if [[ "$all_text_lower" =~ (test|tdd|coverage|spec|unit test|integration test) ]]; then
    echo "  â€¢ Consider tag: needs-tests (testing-related)"
    suggested=true
fi

if [[ "$all_text_lower" =~ (ci|deploy|docker|kubernetes|k8s|infrastructure|devops|build) ]]; then
    echo "  â€¢ Consider tag: infrastructure (CI/deployment/infrastructure)"
    suggested=true
fi

if [[ "$suggested" == false ]]; then
    echo "  (no automatic suggestions - review manually)"
fi

echo ""
echo "To add tags, use: bd tag <bead-id> <tag-name>"
